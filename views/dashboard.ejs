<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DATABANK</title>
  <link rel="stylesheet" href="/css/pdp-theme.css">
</head>
<body>

<!-- Toast -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

<%
  const safeLogs = logs || [];
  const safeUsers = users || [];
  const safeAccessRows = accessRows || [];
  const safeSelectedFolderName = selectedFolderName || null;

  const isAdmin = user.role === 'admin';
  const canSearch = isAdmin || Number(user.can_search);
  const canPreview = isAdmin || Number(user.can_preview);
  const canPrint = isAdmin || Number(user.can_print);

  function toPublicUrl(fp) {
    if (!fp) return '#';
    const p = String(fp).replace(/\\/g, '/').replace('uploadsdocuments', 'uploads/documents');
    return p.startsWith('/') ? p : '/' + p;
  }
%>

<header>
  <div class="header-left"></div>

  <div class="header-title">
    <h1 class="title-line1">DIRECTORATE OF ORGANIZATION AND MOBILIZATION</h1>
    <h1 class="title-line2">DATABANK</h1>
  </div>

  <div class="header-right">
    <img src="/images/pdp-logo.png" alt="PDP Logo">
    <div class="user-info">
      <strong><%= user.fullname %></strong><br>
      <small><%= user.role.toUpperCase() %></small>
    </div>
    <form action="/logout" method="GET">
      <button class="logout-btn">Logout</button>
    </form>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <% if (isAdmin) { %>
        <button class="action-btn" onclick="openModal('userModal')">User Management</button>
        <button class="action-btn" onclick="openModal('logsModal')">Activity Logs</button>
      <% } %>
      <button class="action-btn" onclick="openModal('folderModal')">Folder Management</button>
      <button class="action-btn red" onclick="openModal('fileModal')">File Management</button>
    </div>

    <!-- RIGHT -->
    <div class="card">

      <% if (canSearch) { %>
        <form method="GET" action="/files/search" class="search-bar">
          <input class="search-input search-keyword" type="text" name="keyword" placeholder="Search file name">
          <input class="search-input search-date" type="date" name="date">
          <button class="search-btn">Search</button>
        </form>
      <% } %>

      <h3 class="recent-title">Recent Files</h3>

      <div id="protectedArea" class="protected-area recent-files-area">
        <table class="recent-table">
          <tr>
            <th>File Name</th>
            <th>Date</th>
            <th>Time</th>
            <th>Action</th>
          </tr>

          <% (files || []).forEach(f => { 
            const d = new Date(f.uploaded_at);
          %>
          <tr>
            <td><%= f.filename %></td>
            <td><%= d.toLocaleDateString() %></td>
            <td><%= d.toLocaleTimeString() %></td>
            <td>
              <% if (canPreview) { %>
                <a href="<%= toPublicUrl(f.filepath) %>" target="_blank">Preview</a>
              <% } else { %>
                <span class="disabled-action">Preview</span>
              <% } %>
            </td>
          </tr>
          <% }) %>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- USER MANAGEMENT MODAL -->
<div id="userModal" class="modal">
  <div class="modal-content modal-wide">
    <span class="close" onclick="closeModal('userModal')">&times;</span>
    <h3>User Management</h3>
    <!-- (UNCHANGED: your full user management layout stays here) -->
  </div>
</div>

<!-- FILE MODAL -->
<div id="fileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('fileModal')">&times;</span>
    <h3>File Management</h3>
    <!-- unchanged -->
  </div>
</div>

<!-- FOLDER MODAL -->
<div id="folderModal" class="modal">
  <div class="modal-content modal-wide modal-full">
    <span class="close" onclick="closeModal('folderModal')">&times;</span>
    <h3>Folder Management</h3>
    <!-- unchanged -->
  </div>
</div>

<!-- LOGS MODAL -->
<div id="logsModal" class="modal">
  <div class="modal-content modal-wide">
    <span class="close" onclick="closeModal('logsModal')">&times;</span>
    <h3>Activity Logs</h3>
  </div>
</div>

<footer>
  Directorate of Organization and Mobilization © 2026
</footer>

<script>
function openModal(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
}

function closeModal(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}

/* Toasts */
function showToast(msg, type="success") {
  const t = document.getElementById("toast");
  t.className = `toast toast-${type} show`;
  t.innerText = msg;
  setTimeout(() => t.classList.remove("show"), 3500);
}

/* ✅ AUTO-OPEN MODAL AFTER REDIRECT */
(function () {
  const params = new URLSearchParams(window.location.search);
  const open = params.get("open");
  const success = params.get("success");
  const error = params.get("error");

  if (open) openModal(open);
  if (success) showToast(success, "success");
  if (error) showToast(error, "error");

  if (open || success || error) {
    window.history.replaceState({}, document.title, window.location.pathname);
  }
})();
</script>

</body>
</html>
